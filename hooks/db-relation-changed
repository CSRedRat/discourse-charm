#!/bin/bash

set -e

charm_dir=`pwd`
relation-set database="${JUJU_UNIT_NAME%%/*}" # In the :db relation of psql needed this, we're db-admin now.

juju-log "Sent things over the wire, wait for response."

database="${JUJU_UNIT_NAME%%/*}"
user=`relation-get user`
pass=`relation-get password`
host=`relation-get host`
port=`relation-get port`
# This is required for some reason. It has nothing to do with database at all.
me=`unit-get private-address`

if [ -z "$user" ] || [ -z "$host" ]; then
  juju-log "Waiting for items on the wire"
  exit 0
fi

cat > /home/discourse/discourse/config/database.yml <<EOF
# This file was generated by Juju DON'T EDIT IT!
production:
  adapter: postgresql
  database: $database
  pool: 5
  timeout: 5000
  username: $user
  password: $pass
  port: $port
  host: $host
  host_names:
    - $me
EOF

if [ ! -f ".psql" ]; then
  cat > .psql <<EOF
# This file was generated by Juju!
db_host=$host
db_port=$port
db_user=$user
db_pass=$pass
db_dbdb=$database
EOF

  juju-log "Creating PostgreSQL Database"
  #cd /home/discourse/discourse
  #sudo -u discourse -H bundle exec rake db:create RAILS_ENV="production"
  # Had weird problems with the above, opting instead to just createdb
  set +e
  PGPASSWORD=$pass createdb -U $user -h $host $database
  created=$?
  set -e
  if [ $created -gt 0 ]; then
    # We can just ASSUME that it was created already and hope postgresql
    # isn't broken...
    juju-log "Database already exists, yay, opening ports"
    open-port 80/tcp
    hooks/config-changed
    start discourse || restart discourse
    exit 0
  fi
fi

cd /home/discourse/discourse

export RAILS_ENV="production"

juju-log "Creating secret token"

token=`sudo -u discourse -H bundle exec rake secret`
cat > config/initializers/secret_token.rb <<EOF
Discourse::Application.config.secret_token = "$token"
EOF

echo "$token" > $CHARM_DIR/.secret_token

juju-log "Raking databases and planting seeds!"
sudo -u discourse -H bundle exec rake db:migrate RAILS_ENV="production"
sudo -u discourse -H bundle exec rake db:seed_fu RAILS_ENV="production"

juju-log "Create assets"
sudo -u discourse -H bundle exec rake assets:clean RAILS_ENV="production"
sudo -u discourse -H bundle exec rake assets:precompile RAILS_ENV="production"

juju-log "Database set up"

cd $charm_dir

open-port 80/tcp

hooks/config-changed

start discourse

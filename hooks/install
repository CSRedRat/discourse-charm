#!/bin/bash

set -e

apt-get install -qy ruby1.9.3 git-core build-essential libxml2-dev \
  libxslt1-dev libpq-dev nginx redis-server

charm_dir=`pwd`

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

juju-log "Installing upstart scripts"
rsync -az contrib/upstart/*.conf /etc/init/

juju-log "Bundler ho!"
gem install bundler

set +e
id discourse
user_exists=$?
set -e

if [ $user_exists -gt 0 ]; then
  juju-log "Create discourse user"
  adduser --disabled-password --gecos 'Discourse' discourse
fi

# Discourse should probably use gunicon. gunicorn is cool.
juju-log "Placing nginx configuration files"
rsync -az contrib/nginx/ /etc/nginx/sites-available/
rm -f /etc/nginx/sites-enabled/default
ln -s ../sites-available/discourse /etc/nginx/sites-enabled/discourse

service nginx restart

if [ -d "/home/discourse/discourse" ]; then
  juju-log "Updating source..."
  cd /home/discourse/discourse
  git pull
else
  juju-log "Fetching source..."
  git clone https://github.com/discourse/discourse.git /home/discourse/discourse
  cd /home/discourse/discourse
fi

export RAILS_ENV="production"

juju-log "Bundle install"
bundle install

juju-log "Resetting permissions because gems and rake are lame"
chown -R discourse.discourse /home/discourse/discourse

juju-log "That's it! Time to wait for hooks to fire."

#!/bin/bash

set -ex

admins=`config-get admins`
webs=`config-get thins`

potential_admins=`echo "$admins" | tr -d ' ' | tr -d "'" | sed 's/,/ /g'`

if [ ! -f ".psql" ]; then
  juju-log "Waiting for a database"
  exit 0
fi

source $CHARM_DIR/.psql

export PGPASSWORD=$db_pass

if [ ! -z "$potential_admins" ]; then
  for i in ${potential_admins}; do
    juju-log "Attempting to add admin for $i"
    echo "UPDATE users SET admin=true WHERE username='$i'" | psql -h $db_host -U $db_user $db_dbdb
  done
fi

juju-log "Running upgrade-charm to handle the rest of configuration"

hooks/upgrade-charm
if [ -f /etc/default/discourse ]; then
  . /etc/default/discourse
else
  THINS=0
fi

if [ "$webs" == "auto" ]; then
  # Count the RAM and CPU. Find the lowest and get a number. 1 RAM/CPU = 1 THIN. Miniumum 1
  ram=$(expr `cat /proc/meminfo | grep MemTotal | awk '{print $2}'` / `expr 1024 * 1024`)
  cpu=`nproc`

  if [ $ram -gt $cpu ]; then
    webs=$cpu
  else
    webs=$ram
  fi

  if [ $webs -le 0 ]; then
    webs=1
  fi
fi

if [ $THINS -ne $webs ]; then
  cat <<EOD > /etc/default/discourse
THINS=$webs
START_PORT=3000
EOD

  for i in `initctl list | grep ^discourse-web` | awk '{print $2}' | tr -d ')' | tr -d '('`; do
    juju-log "Stopping discourse-web on $i port"
    stop discourse-web PORT=$i
  done

  juju-log "Re-starting discourse thins"
  start discourse-webs
fi
